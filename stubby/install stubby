Command-line instructions
1.) Install the required packages:

opkg update
opkg install stubby
2.) Enable DNS encryption:

service dnsmasq stop
uci set dhcp.@dnsmasq[0].noresolv="1"
uci -q delete dhcp.@dnsmasq[0].server
uci -q get stubby.global.listen_address \
| sed -e "s/\s/\n/g;s/@/#/g" \
| while read -r STUBBY_SERV
do uci add_list dhcp.@dnsmasq[0].server="${STUBBY_SERV}"
done
3.) Disable local use of dnsmasq/stubby: It is not possible for Stubby to be UP during boot or just right after boot, without additional configuration, because of the race condition with SYSNTPd service. race_conditions_with_sysntpd

uci set dhcp.@dnsmasq[0].localuse="0"
4.) Commit changes:

uci commit dhcp
service dnsmasq start
LAN clients should use Dnsmasq as a primary resolver. Dnsmasq forwards DNS queries to Stubby which encrypts DNS traffic.

Testing
Verify domain name resolution with nslookup:

nslookup openwrt.org localhost
To check your DNS provider, you can use:

Cloudflare Test
AdGuard Test
NextDNS Test
Mullvad Test
Quad9 Test
OpenDNS Test
Cloudflare Browser Check
DNS Leak Test and DNSSEC Test:

DNS Leak Test #1
DNS Leak Test #2
DNSSEC Test #1
DNSSEC Test #2
Alternative test via CLI: * check connection to Quad9 DNS (it require to use Quad9 DNS servers):

dig +short txt proto.on.quad9.net.
# should print: doh. or dot.
* check connection to NextDNS (it require to use NextDNS DNS servers):

curl -SL https://test.nextdns.io/
{
        "status": "ok",
        "protocol": "DOT",
        "profile": "SOMEPROFILE",
        "client": "80.XXX.XXX.XXX",
        "srcIP": "80.XXX.XXX.XXX",
        "destIP": "XX.XX.28.0",
        "anycast": true,
        "server": "zepto-ber-1",
        "clientName": "unknown-dot"
}
Alternate Testing sites
https://www.cloudflare.com/ssl/encrypted-sni/
https://1.1.1.1/help
Troubleshooting
Collect and analyze the following information.

# Restart services
service log restart; service dnsmasq restart; service stubby restart
 
# Log and status
logread -e dnsmasq; netstat -l -n -p | grep -e dnsmasq
logread -e stubby; netstat -l -n -p | grep -e stubby
 
# Runtime configuration
pgrep -f -a dnsmasq; pgrep -f -a stubby
head -v -n -0 /etc/resolv.* /tmp/resolv.* /tmp/resolv.*/*
 
# Persistent configuration
uci show dhcp
uci show stubby
